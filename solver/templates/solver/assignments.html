{% extends 'base/layout.html' %}
{% load static %}

{% block main %}
<main class="container mx-auto p-4 flex flex-col space-y-8">
  <header>
    <h1 class="font-semibold text-xl flex flex-row space-x-2">
      <a class="text-blue-500 hover:underline cursor-pointer"
         href="{% url 'index' %}">
        Ãœbersicht
      </a>
      <span>&rsaquo;</span>
      <a class="text-blue-500 hover:underline cursor-pointer"
         href="{% url 'schedule' schedule.pk %}">
        Stundenplan {{ schedule.pk }}
      </a>
      <span>&rsaquo;</span>
      <span class="text-blue-500">
        Dienstplan
      </span>
    </h1>
  </header>
  <section class="flex flex-row space-x-2">
    <button id="solve"
            class="px-4 p-2 leading-none cursor-pointer rounded-lg 
		   bg-green-600 hover:bg-green-500 text-white">
      Dienstplan erstellen
    </button>
  </section>
  <section class="hidden px-4 py-2 border rounded-lg text-white"
           id="info"></section>
  <div id="calendar"></div>
</main>
{% endblock %}

{% block scripts %}
<script src="{% static 'solver/js/calendar.js' %}"></script>
<script>
  function patchSchedule(){
      let info = document.getElementById("info");
      fetch("{% url 'api:schedule' schedule.pk %}", {
          method: "PATCH",
          headers: {
              "X-CSRFToken": "{{ csrf_token }}",
          }
      }).then(r => {
          if (r.ok) {
              info.classList.remove("hidden");
              info.classList.remove("border-red-600", "bg-red-600");
              info.classList.add("border-green-600", "bg-green-600");
              info.innerText = "Dienstplan wurde erstellt.";
          } else {
              info.classList.remove("hidden");
              info.classList.add("border-red-600", "bg-red-600");
              info.classList.remove("border-green-600", "bg-green-600");
              console.log(r);
              r.json().then(json => {
                  info.innerText = json.error;
              })
          }
      }).then(() => c.refetchEvents())
  }

  document.getElementById("solve").addEventListener("click", patchSchedule);

  
  let c = new FullCalendar.Calendar(document.getElementById("calendar"), {
      locale: "de",
      buttonText: {
          "today": "Heute",
      },
      initialView: "dayGridMonth",
      events: {
          url: "{% url 'api:assignments' schedule.pk %}",
      },
      eventClassNames: "p-2",
      eventDataTransform(data){
          data.title = data.username;
          return data;
      },
  });
  c.render();
</script>
{% endblock %}
