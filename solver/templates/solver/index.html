{% extends "base/layout.html" %}

{% block main %}
<div class="container mx-auto max-w-4xl">
  <div id="calendar" class="mt-8"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function addEvent(url, data){
      return fetch(url, {
	  method: "POST",
	  headers: {
	      "Content-Type": "application/json",
	      "X-CSRFToken": "{{ csrf_token }}",
	  },
	  body: JSON.stringify(data),
      });
  }
  function deleteEvent(event){
      let url = event.url;
      return fetch(url, {
	  method: "DELETE",
	  headers: {
	      "X-CSRFToken": "{{ csrf_token }}",
	  },
      })
  }
  const calendarEl = document.getElementById("calendar");
  const calendarOptions = {
      initialView: "dayGridMonth",
      locale: "de",
      height: "auto",
      buttonText: {
	  "today": "Heute",
	  "month": "Monatsansicht",
      },
      eventSources: [
	  {
	      url: "{% url 'day_preferences' %}",
	  },
      ],
      eventClick: function(info){
	  info.jsEvent.preventDefault();
	  deleteEvent(info.event).then(_ => info.event.source.refetch())
      },
      dateClick: function(info){
	  let start = info.dateStr,
	      events = this.getEvents().filter(e => e.startStr == start),
	      source = this.getEventSources()[0],
	      promise = (events.length == 0)
	      ? addEvent(source.url, { start: start })
	      : Promise.all(events.map(e => deleteEvent(e)));
	  promise.then(_ => source.refetch());
      },
      eventDataTransform: function(data){
	  let color = data.available ? "rgb(34 197 94)" : "red";
	  data.backgroundColor = color;
	  data.borderColor = color;
	  return data;
      }
  };
  const calendar = new FullCalendar.Calendar(calendarEl, calendarOptions);
  calendar.render();
</script>
{% endblock %}
